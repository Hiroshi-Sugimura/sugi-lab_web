<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebBLE Central - Peripheral Test Tool</title>    <style>
        /* AppleÈ¢®„Éá„Ç∂„Ç§„É≥„Ç∑„Çπ„ÉÜ„É†Ê∫ñÊã† */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'Helvetica Neue', sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 16px;
            background: #F5F5F7;
            min-height: 100vh;
            color: #1D1D1F;
            line-height: 1.5;
        }

        .container {
            background: #FFFFFF;
            padding: 24px;
            border-radius: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
            margin-bottom: 24px;
        }

        h1 {
            color: #000000;
            text-align: center;
            margin-bottom: 32px;
            font-size: 34px;
            font-weight: 700;
            line-height: 1.2;
        }

        .control-section {
            margin-bottom: 32px;
            padding: 20px;
            background: #FFFFFF;
            border-radius: 16px;
            border: 1px solid #EEEEEE;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
        }

        .control-section h2 {
            color: #000000;
            margin-top: 0;
            margin-bottom: 16px;
            font-size: 22px;
            font-weight: 600;
            line-height: 1.3;
        }

        .button-group {
            display: flex;
            gap: 16px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        button {
            padding: 12px 24px;
            font-size: 17px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 600;
            min-height: 44px;
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'Helvetica Neue', sans-serif;
        }

        .btn-primary {
            background: #007AFF;
            color: #FFFFFF;
        }

        .btn-primary:hover {
            background: #0056CC;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3);
        }

        .btn-primary:disabled {
            background: #007AFF;
            opacity: 0.3;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: transparent;
            color: #007AFF;
            border: 1px solid #007AFF;
        }

        .btn-secondary:hover {
            background: #007AFF;
            color: #FFFFFF;
        }

        .btn-secondary:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .btn-danger {
            background: #FF3B30;
            color: #FFFFFF;
        }

        .btn-danger:hover {
            background: #D70015;
        }

        .btn-danger:disabled {
            background: #FF3B30;
            opacity: 0.3;
            cursor: not-allowed;
        }

        .btn-success {
            background: #4CD964;
            color: #FFFFFF;
        }

        .btn-success:hover {
            background: #32D74B;
        }

        .btn-success:disabled {
            background: #4CD964;
            opacity: 0.3;
            cursor: not-allowed;
        }

        .status {
            padding: 16px;
            margin: 16px 0;
            border-radius: 12px;
            font-weight: 500;
            font-size: 17px;
        }

        .status.connected {
            background: rgba(76, 217, 100, 0.15);
            color: #2D7D32;
            border: 1px solid rgba(76, 217, 100, 0.3);
        }

        .status.disconnected {
            background: rgba(255, 59, 48, 0.15);
            color: #C62828;
            border: 1px solid rgba(255, 59, 48, 0.3);
        }

        .status.scanning {
            background: rgba(255, 149, 0, 0.15);
            color: #E65100;
            border: 1px solid rgba(255, 149, 0, 0.3);
        }

        .device-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #EEEEEE;
            border-radius: 12px;
            margin: 16px 0;
            background: #FFFFFF;
        }

        .device-item {
            padding: 16px;
            border-bottom: 1px solid #EEEEEE;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .device-item:hover {
            background: #F5F5F7;
        }

        .device-item:last-child {
            border-bottom: none;
        }

        .device-name {
            font-weight: 600;
            color: #000000;
            margin-bottom: 4px;
            font-size: 17px;
        }

        .device-id {
            color: #666666;
            font-size: 14px;
            font-family: 'SF Mono', Menlo, Monaco, 'Courier New', monospace;
        }

        .log-area {
            background: #1D1D1F;
            color: #F5F5F7;
            padding: 16px;
            border-radius: 12px;
            height: 200px;
            overflow-y: auto;
            font-family: 'SF Mono', Menlo, Monaco, 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.4;
        }

        .input-group {
            display: flex;
            gap: 16px;
            margin: 16px 0;
            align-items: center;
        }

        .input-group label {
            min-width: 120px;
            font-weight: 500;
            color: #000000;
            font-size: 17px;
        }

        .input-group input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid #EEEEEE;
            border-radius: 8px;
            font-size: 17px;
            background: #FFFFFF;
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'Helvetica Neue', sans-serif;
            transition: border-color 0.2s ease;
        }

        .input-group input:focus {
            outline: none;
            border-color: #007AFF;
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.2);
        }

        .characteristics-list {
            background: #FFFFFF;
            border: 1px solid #EEEEEE;
            border-radius: 16px;
            padding: 20px;
            margin: 16px 0;
        }

        .characteristic-item {
            padding: 16px;
            border-bottom: 1px solid #EEEEEE;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .characteristic-item:last-child {
            border-bottom: none;
        }

        .characteristic-uuid {
            font-family: 'SF Mono', Menlo, Monaco, 'Courier New', monospace;
            font-size: 14px;
            color: #666666;
        }

        .characteristic-controls {
            display: flex;
            gap: 8px;
        }

        .characteristic-controls button {
            padding: 8px 16px;
            font-size: 14px;
            min-height: 32px;
            border-radius: 8px;
        }

        .data-display {
            background: #F5F5F7;
            padding: 16px;
            border-radius: 12px;
            margin: 16px 0;
            font-family: 'SF Mono', Menlo, Monaco, 'Courier New', monospace;
            font-size: 14px;
            border: 1px solid #EEEEEE;
            color: #1D1D1F;
        }

        .error {
            background: rgba(255, 59, 48, 0.15);
            color: #C62828;
            border: 1px solid rgba(255, 59, 48, 0.3);
            padding: 16px;
            border-radius: 12px;
            margin: 16px 0;
            font-size: 17px;
        }

        /* „É¨„Çπ„Éù„É≥„Ç∑„Éñ„Éá„Ç∂„Ç§„É≥ */
        @media (max-width: 767px) {
            body {
                padding: 16px;
            }

            .container {
                padding: 16px;
            }

            .control-section {
                padding: 16px;
            }

            .button-group {
                flex-direction: column;
                gap: 8px;
            }

            .input-group {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }

            .input-group label {
                min-width: auto;
            }

            .characteristic-controls {
                flex-direction: column;
                gap: 4px;
            }

            h1 {
                font-size: 28px;
            }
        }

        @media (min-width: 768px) and (max-width: 1023px) {
            body {
                padding: 24px;
            }

            .container {
                padding: 20px;
            }
        }

        @media (min-width: 1024px) {
            body {
                padding: 32px;
            }

            .container {
                padding: 24px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîµ WebBLE Central</h1>
        <p style="text-align: center; color: #6c757d; margin-bottom: 30px;">
            BLE Peripheral „Éá„Éê„Ç§„Çπ„ÅÆ„ÉÜ„Çπ„Éà„ÉÑ„Éº„É´
        </p>

        <!-- Êé•Á∂öÁä∂ÊÖã -->
        <div class="control-section">
            <h2>üì° Êé•Á∂öÁä∂ÊÖã</h2>
            <div id="connectionStatus" class="status disconnected">
                Êú™Êé•Á∂ö
            </div>
            <div id="deviceInfo" style="display: none;">
                <strong>Êé•Á∂ö‰∏≠„Éá„Éê„Ç§„Çπ:</strong> <span id="connectedDeviceName"></span><br>
                <strong>Device ID:</strong> <span id="connectedDeviceId"></span>
            </div>
        </div>

        <!-- „Éá„Éê„Ç§„ÇπÊ§úÁ¥¢„ÉªÊé•Á∂ö -->
        <div class="control-section">
            <h2>üîç „Éá„Éê„Ç§„ÇπÊ§úÁ¥¢„ÉªÊé•Á∂ö</h2>
            <div class="button-group">
                <button id="scanBtn" class="btn-primary">„Éá„Éê„Ç§„Çπ„Çí„Çπ„Ç≠„É£„É≥</button>
                <button id="connectBtn" class="btn-success" disabled>ÈÅ∏Êäû„Åó„Åü„Éá„Éê„Ç§„Çπ„Å´Êé•Á∂ö</button>
                <button id="disconnectBtn" class="btn-danger" disabled>ÂàáÊñ≠</button>
            </div>

            <div id="deviceList" class="device-list" style="display: none;"></div>
            <div id="scanStatus" style="display: none;"></div>
        </div>

        <!-- „Çµ„Éº„Éì„Çπ„ÉªÁâπÊÄß -->
        <div class="control-section">
            <h2>‚öôÔ∏è „Çµ„Éº„Éì„Çπ„ÉªÁâπÊÄß</h2>
            <div class="button-group">
                <button id="discoverBtn" class="btn-secondary" disabled>„Çµ„Éº„Éì„Çπ„ÇíÊé¢Á¥¢</button>
                <button id="refreshServicesBtn" class="btn-secondary" disabled>„Çµ„Éº„Éì„Çπ‰∏ÄË¶ß„ÇíÊõ¥Êñ∞</button>
            </div>

            <div id="servicesList" class="characteristics-list" style="display: none;"></div>
        </div>

        <!-- „Éá„Éº„ÇøÈÄÅÂèó‰ø° -->
        <div class="control-section">
            <h2>üì° „Éá„Éº„ÇøÈÄÅÂèó‰ø°</h2>

            <div class="input-group">
                <label for="writeData">ÈÄÅ‰ø°„Éá„Éº„Çø:</label>
                <input type="text" id="writeData" placeholder="ÈÄÅ‰ø°„Åô„Çã„Éá„Éº„Çø„ÇíÂÖ•Âäõ (‰æã: Hello BLE!)">
                <button id="writeBtn" class="btn-primary" disabled>ÈÄÅ‰ø°</button>
            </div>

            <div class="input-group">
                <label for="writeHex">HEXÈÄÅ‰ø°:</label>
                <input type="text" id="writeHex" placeholder="HEX„Éá„Éº„Çø„ÇíÂÖ•Âäõ (‰æã: 48656C6C6F)">
                <button id="writeHexBtn" class="btn-primary" disabled>HEXÈÄÅ‰ø°</button>
            </div>

            <div class="button-group">
                <button id="readBtn" class="btn-secondary" disabled>„Éá„Éº„Çø„ÇíË™≠Âèñ</button>
                <button id="subscribeBtn" class="btn-secondary" disabled>ÈÄöÁü•„ÇíÈñãÂßã</button>
                <button id="unsubscribeBtn" class="btn-secondary" disabled>ÈÄöÁü•„ÇíÂÅúÊ≠¢</button>
            </div>

            <div id="receivedData" class="data-display" style="display: none;">
                <strong>Âèó‰ø°„Éá„Éº„Çø:</strong><br>
                <div id="dataContent"></div>
            </div>
        </div>

        <!-- „É≠„Ç∞ -->
        <div class="control-section">
            <h2>üìã „É≠„Ç∞</h2>
            <div class="button-group">
                <button id="clearLogBtn" class="btn-secondary">„É≠„Ç∞„Çí„ÇØ„É™„Ç¢</button>
            </div>
            <div id="logArea" class="log-area"></div>
        </div>
    </div>

    <script>
        class WebBLECentral {
            constructor() {
                this.device = null;
                this.server = null;
                this.services = new Map();
                this.characteristics = new Map();
                this.selectedCharacteristic = null;
                this.isScanning = false;
                this.discoveredDevices = new Map();

                this.initializeUI();
                this.checkBluetoothSupport();
            }

            initializeUI() {
                // „Éú„Çø„É≥„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº
                document.getElementById('scanBtn').addEventListener('click', () => this.scanDevices());
                document.getElementById('connectBtn').addEventListener('click', () => this.connectToSelectedDevice());
                document.getElementById('disconnectBtn').addEventListener('click', () => this.disconnect());
                document.getElementById('discoverBtn').addEventListener('click', () => this.discoverServices());
                document.getElementById('refreshServicesBtn').addEventListener('click', () => this.refreshServices());
                document.getElementById('writeBtn').addEventListener('click', () => this.writeData());
                document.getElementById('writeHexBtn').addEventListener('click', () => this.writeHexData());
                document.getElementById('readBtn').addEventListener('click', () => this.readData());
                document.getElementById('subscribeBtn').addEventListener('click', () => this.subscribeToNotifications());
                document.getElementById('unsubscribeBtn').addEventListener('click', () => this.unsubscribeFromNotifications());
                document.getElementById('clearLogBtn').addEventListener('click', () => this.clearLog());
            }

            checkBluetoothSupport() {
                if (!navigator.bluetooth) {
                    this.log('‚ùå Web Bluetooth API „Åå„Çµ„Éù„Éº„Éà„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì', 'error');
                    this.showError('„Åì„ÅÆ„Éñ„É©„Ç¶„Ç∂„ÅØ Web Bluetooth API „Çí„Çµ„Éù„Éº„Éà„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇChrome„ÄÅEdge„ÄÅOpera„Çí„ÅîÂà©Áî®„Åè„Å†„Åï„ÅÑ„ÄÇ');
                    return false;
                }
                this.log('‚úÖ Web Bluetooth API „Åå„Çµ„Éù„Éº„Éà„Åï„Çå„Å¶„ÅÑ„Åæ„Åô', 'success');
                return true;
            }

            async scanDevices() {
                if (!this.checkBluetoothSupport()) return;

                try {
                    this.log('üîç „Éá„Éê„Ç§„Çπ„ÅÆ„Çπ„Ç≠„É£„É≥„ÇíÈñãÂßã„Åó„Åæ„Åô...', 'info');
                    this.updateScanStatus('scanning');

                    // „Åô„Åπ„Å¶„ÅÆBLE„Éá„Éê„Ç§„Çπ„ÇíÊ§úÁ¥¢Ôºà„Éï„Ç£„É´„Çø„Éº„Å™„ÅóÔºâ
                    const device = await navigator.bluetooth.requestDevice({
                        acceptAllDevices: true,
                        optionalServices: ['generic_access', 'generic_attribute', 'device_information']
                    });

                    this.discoveredDevices.clear();
                    this.discoveredDevices.set(device.id, device);
                    this.displayDeviceList();

                    this.log(`‚úÖ „Éá„Éê„Ç§„Çπ„ÇíÁô∫Ë¶ã: ${device.name || 'Unknown'} (${device.id})`, 'success');
                    document.getElementById('connectBtn').disabled = false;

                } catch (error) {
                    this.log(`‚ùå „Çπ„Ç≠„É£„É≥„Ç®„É©„Éº: ${error.message}`, 'error');
                    this.showError(`„Éá„Éê„Ç§„Çπ„ÅÆ„Çπ„Ç≠„É£„É≥„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ${error.message}`);
                } finally {
                    this.updateScanStatus('idle');
                }
            }

            displayDeviceList() {
                const deviceList = document.getElementById('deviceList');
                deviceList.innerHTML = '';

                if (this.discoveredDevices.size === 0) {
                    deviceList.style.display = 'none';
                    return;
                }

                deviceList.style.display = 'block';

                this.discoveredDevices.forEach((device, id) => {
                    const deviceItem = document.createElement('div');
                    deviceItem.className = 'device-item';
                    deviceItem.innerHTML = `
                        <div class="device-name">${device.name || 'Unknown Device'}</div>
                        <div class="device-id">${device.id}</div>
                    `;

                    deviceItem.addEventListener('click', () => {
                        // ÈÅ∏ÊäûÁä∂ÊÖã„ÇíÊõ¥Êñ∞
                        document.querySelectorAll('.device-item').forEach(item => {
                            item.style.background = '';
                        });
                        deviceItem.style.background = '#e3f2fd';

                        this.selectedDevice = device;
                        this.log(`üì± „Éá„Éê„Ç§„Çπ„ÇíÈÅ∏Êäû: ${device.name || 'Unknown'} (${device.id})`, 'info');
                    });

                    deviceList.appendChild(deviceItem);
                });
            }

            async connectToSelectedDevice() {
                if (!this.selectedDevice) {
                    this.showError('„Éá„Éê„Ç§„Çπ„ÅåÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
                    return;
                }

                try {
                    this.log(`üîó „Éá„Éê„Ç§„Çπ„Å´Êé•Á∂ö‰∏≠: ${this.selectedDevice.name || 'Unknown'}...`, 'info');

                    this.device = this.selectedDevice;
                    this.server = await this.device.gatt.connect();

                    this.device.addEventListener('gattserverdisconnected', () => {
                        this.onDisconnected();
                    });

                    this.updateConnectionStatus(true);
                    this.log(`‚úÖ Êé•Á∂öÊàêÂäü: ${this.device.name || 'Unknown'} (${this.device.id})`, 'success');

                    // Êé•Á∂öÂæå„Å´Âü∫Êú¨ÁöÑ„Å™„Çµ„Éº„Éì„Çπ„ÇíÊé¢Á¥¢
                    await this.discoverServices();

                } catch (error) {
                    this.log(`‚ùå Êé•Á∂ö„Ç®„É©„Éº: ${error.message}`, 'error');
                    this.showError(`„Éá„Éê„Ç§„Çπ„Å∏„ÅÆÊé•Á∂ö„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ${error.message}`);
                }
            }

            async discoverServices() {
                if (!this.server) {
                    this.showError('„Éá„Éê„Ç§„Çπ„ÅåÊé•Á∂ö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
                    return;
                }

                try {
                    this.log('üîç „Çµ„Éº„Éì„Çπ„ÇíÊé¢Á¥¢‰∏≠...', 'info');

                    const services = await this.server.getPrimaryServices();
                    this.services.clear();
                    this.characteristics.clear();

                    for (const service of services) {
                        this.services.set(service.uuid, service);

                        try {
                            const characteristics = await service.getCharacteristics();
                            for (const characteristic of characteristics) {
                                this.characteristics.set(characteristic.uuid, characteristic);
                            }
                        } catch (error) {
                            this.log(`‚ö†Ô∏è „Çµ„Éº„Éì„Çπ ${service.uuid} „ÅÆÁâπÊÄßÂèñÂæó„Å´Â§±Êïó: ${error.message}`, 'warning');
                        }
                    }

                    this.displayServices();
                    this.log(`‚úÖ ${services.length} ÂÄã„ÅÆ„Çµ„Éº„Éì„Çπ„ÇíÁô∫Ë¶ã`, 'success');

                } catch (error) {
                    this.log(`‚ùå „Çµ„Éº„Éì„ÇπÊé¢Á¥¢„Ç®„É©„Éº: ${error.message}`, 'error');
                    this.showError(`„Çµ„Éº„Éì„Çπ„ÅÆÊé¢Á¥¢„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ${error.message}`);
                }
            }

            displayServices() {
                const servicesList = document.getElementById('servicesList');
                servicesList.innerHTML = '';

                if (this.services.size === 0) {
                    servicesList.style.display = 'none';
                    return;
                }

                servicesList.style.display = 'block';

                this.services.forEach((service, uuid) => {
                    const serviceItem = document.createElement('div');
                    serviceItem.innerHTML = `
                        <h4 style="margin: 10px 0 5px 0; color: #2d3748;">üìã Service: ${this.getServiceName(uuid)}</h4>
                        <div style="font-size: 0.9em; color: #6c757d; margin-bottom: 10px;">${uuid}</div>
                    `;

                    // „Åì„ÅÆ„Çµ„Éº„Éì„Çπ„ÅÆÁâπÊÄß„ÇíË°®Á§∫
                    const characteristicsContainer = document.createElement('div');
                    characteristicsContainer.style.marginLeft = '20px';

                    this.characteristics.forEach((characteristic, charUuid) => {
                        if (characteristic.service.uuid === uuid) {
                            const charItem = document.createElement('div');
                            charItem.className = 'characteristic-item';

                            const properties = [];
                            if (characteristic.properties.read) properties.push('Read');
                            if (characteristic.properties.write) properties.push('Write');
                            if (characteristic.properties.notify) properties.push('Notify');
                            if (characteristic.properties.indicate) properties.push('Indicate');

                            charItem.innerHTML = `
                                <div>
                                    <strong>‚öôÔ∏è ${this.getCharacteristicName(charUuid)}</strong><br>
                                    <span class="characteristic-uuid">${charUuid}</span><br>
                                    <small>Properties: ${properties.join(', ')}</small>
                                </div>
                                <div class="characteristic-controls">
                                    ${characteristic.properties.read ? '<button class="btn-secondary" onclick="central.selectCharacteristic(\'' + charUuid + '\'); central.readData();">Read</button>' : ''}
                                    ${characteristic.properties.write ? '<button class="btn-primary" onclick="central.selectCharacteristic(\'' + charUuid + '\');">Select</button>' : ''}
                                    ${characteristic.properties.notify ? '<button class="btn-secondary" onclick="central.selectCharacteristic(\'' + charUuid + '\'); central.subscribeToNotifications();">Notify</button>' : ''}
                                </div>
                            `;

                            characteristicsContainer.appendChild(charItem);
                        }
                    });

                    serviceItem.appendChild(characteristicsContainer);
                    servicesList.appendChild(serviceItem);
                });
            }

            selectCharacteristic(uuid) {
                this.selectedCharacteristic = this.characteristics.get(uuid);
                if (this.selectedCharacteristic) {
                    this.log(`üéØ ÁâπÊÄß„ÇíÈÅ∏Êäû: ${this.getCharacteristicName(uuid)}`, 'info');
                    this.updateDataControls();
                }
            }

            updateDataControls() {
                const hasCharacteristic = this.selectedCharacteristic !== null;
                const canRead = hasCharacteristic && this.selectedCharacteristic.properties.read;
                const canWrite = hasCharacteristic && this.selectedCharacteristic.properties.write;
                const canNotify = hasCharacteristic && this.selectedCharacteristic.properties.notify;

                document.getElementById('writeBtn').disabled = !canWrite;
                document.getElementById('writeHexBtn').disabled = !canWrite;
                document.getElementById('readBtn').disabled = !canRead;
                document.getElementById('subscribeBtn').disabled = !canNotify;
                document.getElementById('unsubscribeBtn').disabled = !canNotify;
            }

            async writeData() {
                if (!this.selectedCharacteristic) {
                    this.showError('ÁâπÊÄß„ÅåÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
                    return;
                }

                const data = document.getElementById('writeData').value;
                if (!data) {
                    this.showError('ÈÄÅ‰ø°„Éá„Éº„Çø„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                    return;
                }

                try {
                    const encoder = new TextEncoder();
                    const dataArray = encoder.encode(data);

                    await this.selectedCharacteristic.writeValue(dataArray);
                    this.log(`üì§ „Éá„Éº„ÇøÈÄÅ‰ø°ÊàêÂäü: "${data}"`, 'success');

                } catch (error) {
                    this.log(`‚ùå „Éá„Éº„ÇøÈÄÅ‰ø°„Ç®„É©„Éº: ${error.message}`, 'error');
                    this.showError(`„Éá„Éº„Çø„ÅÆÈÄÅ‰ø°„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ${error.message}`);
                }
            }

            async writeHexData() {
                if (!this.selectedCharacteristic) {
                    this.showError('ÁâπÊÄß„ÅåÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
                    return;
                }

                const hexData = document.getElementById('writeHex').value.replace(/\s/g, '');
                if (!hexData) {
                    this.showError('HEX„Éá„Éº„Çø„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                    return;
                }

                try {
                    const bytes = hexData.match(/.{1,2}/g)?.map(byte => parseInt(byte, 16));
                    if (!bytes) {
                        throw new Error('ÁÑ°Âäπ„Å™HEX„Éá„Éº„Çø„Åß„Åô');
                    }

                    const dataArray = new Uint8Array(bytes);
                    await this.selectedCharacteristic.writeValue(dataArray);
                    this.log(`üì§ HEX„Éá„Éº„ÇøÈÄÅ‰ø°ÊàêÂäü: ${hexData}`, 'success');

                } catch (error) {
                    this.log(`‚ùå HEX„Éá„Éº„ÇøÈÄÅ‰ø°„Ç®„É©„Éº: ${error.message}`, 'error');
                    this.showError(`HEX„Éá„Éº„Çø„ÅÆÈÄÅ‰ø°„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ${error.message}`);
                }
            }

            async readData() {
                if (!this.selectedCharacteristic) {
                    this.showError('ÁâπÊÄß„ÅåÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
                    return;
                }

                try {
                    const value = await this.selectedCharacteristic.readValue();
                    this.displayReceivedData(value);
                    this.log(`üì• „Éá„Éº„ÇøË™≠ÂèñÊàêÂäü`, 'success');

                } catch (error) {
                    this.log(`‚ùå „Éá„Éº„ÇøË™≠Âèñ„Ç®„É©„Éº: ${error.message}`, 'error');
                    this.showError(`„Éá„Éº„Çø„ÅÆË™≠Âèñ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ${error.message}`);
                }
            }

            async subscribeToNotifications() {
                if (!this.selectedCharacteristic) {
                    this.showError('ÁâπÊÄß„ÅåÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
                    return;
                }

                try {
                    await this.selectedCharacteristic.startNotifications();
                    this.selectedCharacteristic.addEventListener('characteristicvaluechanged', (event) => {
                        this.displayReceivedData(event.target.value);
                    });

                    this.log(`üîî ÈÄöÁü•„ÇíÈñãÂßã„Åó„Åæ„Åó„Åü`, 'success');

                } catch (error) {
                    this.log(`‚ùå ÈÄöÁü•ÈñãÂßã„Ç®„É©„Éº: ${error.message}`, 'error');
                    this.showError(`ÈÄöÁü•„ÅÆÈñãÂßã„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ${error.message}`);
                }
            }

            async unsubscribeFromNotifications() {
                if (!this.selectedCharacteristic) {
                    this.showError('ÁâπÊÄß„ÅåÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
                    return;
                }

                try {
                    await this.selectedCharacteristic.stopNotifications();
                    this.log(`üîï ÈÄöÁü•„ÇíÂÅúÊ≠¢„Åó„Åæ„Åó„Åü`, 'success');

                } catch (error) {
                    this.log(`‚ùå ÈÄöÁü•ÂÅúÊ≠¢„Ç®„É©„Éº: ${error.message}`, 'error');
                    this.showError(`ÈÄöÁü•„ÅÆÂÅúÊ≠¢„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ${error.message}`);
                }
            }

            displayReceivedData(dataView) {
                const receivedDataDiv = document.getElementById('receivedData');
                const dataContentDiv = document.getElementById('dataContent');

                // „Éê„Ç§„ÉàÈÖçÂàó„Å®„Åó„Å¶Ë°®Á§∫
                const byteArray = new Uint8Array(dataView.buffer);
                const hexString = Array.from(byteArray)
                    .map(b => b.toString(16).padStart(2, '0'))
                    .join(' ');

                // ÊñáÂ≠óÂàó„Å®„Åó„Å¶Ë°®Á§∫ÔºàÂèØËÉΩ„Å™Â†¥ÂêàÔºâ
                const decoder = new TextDecoder();
                let textString = '';
                try {
                    textString = decoder.decode(dataView);
                } catch (error) {
                    textString = '(„Éá„Ç≥„Éº„Éâ‰∏çÂèØ)';
                }

                const timestamp = new Date().toLocaleTimeString();

                dataContentDiv.innerHTML = `
                    <div><strong>ÊôÇÂàª:</strong> ${timestamp}</div>
                    <div><strong>HEX:</strong> ${hexString}</div>
                    <div><strong>„ÉÜ„Ç≠„Çπ„Éà:</strong> ${textString}</div>
                    <div><strong>„Éê„Ç§„ÉàÊï∞:</strong> ${byteArray.length}</div>
                `;

                receivedDataDiv.style.display = 'block';
                this.log(`üì• „Éá„Éº„ÇøÂèó‰ø°: HEX[${hexString}] TEXT[${textString}]`, 'info');
            }

            async disconnect() {
                try {
                    if (this.server) {
                        await this.server.disconnect();
                    }
                    this.onDisconnected();
                    this.log('‚úÖ ÂàáÊñ≠ÂÆå‰∫Ü', 'success');
                } catch (error) {
                    this.log(`‚ùå ÂàáÊñ≠„Ç®„É©„Éº: ${error.message}`, 'error');
                }
            }

            onDisconnected() {
                this.device = null;
                this.server = null;
                this.services.clear();
                this.characteristics.clear();
                this.selectedCharacteristic = null;
                this.updateConnectionStatus(false);
                this.log('üîå „Éá„Éê„Ç§„Çπ„ÅåÂàáÊñ≠„Åï„Çå„Åæ„Åó„Åü', 'warning');
            }

            async refreshServices() {
                if (!this.server) {
                    this.showError('„Éá„Éê„Ç§„Çπ„ÅåÊé•Á∂ö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
                    return;
                }
                await this.discoverServices();
            }

            updateConnectionStatus(connected) {
                const statusDiv = document.getElementById('connectionStatus');
                const deviceInfoDiv = document.getElementById('deviceInfo');

                if (connected && this.device) {
                    statusDiv.className = 'status connected';
                    statusDiv.textContent = 'Êé•Á∂öÊ∏à„Åø';

                    document.getElementById('connectedDeviceName').textContent = this.device.name || 'Unknown';
                    document.getElementById('connectedDeviceId').textContent = this.device.id;
                    deviceInfoDiv.style.display = 'block';

                    document.getElementById('connectBtn').disabled = true;
                    document.getElementById('disconnectBtn').disabled = false;
                    document.getElementById('discoverBtn').disabled = false;
                    document.getElementById('refreshServicesBtn').disabled = false;

                } else {
                    statusDiv.className = 'status disconnected';
                    statusDiv.textContent = 'Êú™Êé•Á∂ö';
                    deviceInfoDiv.style.display = 'none';

                    document.getElementById('connectBtn').disabled = false;
                    document.getElementById('disconnectBtn').disabled = true;
                    document.getElementById('discoverBtn').disabled = true;
                    document.getElementById('refreshServicesBtn').disabled = true;

                    // „Éá„Éº„ÇøÊìç‰Ωú„Éú„Çø„É≥„ÇÇÁÑ°ÂäπÂåñ
                    document.getElementById('writeBtn').disabled = true;
                    document.getElementById('writeHexBtn').disabled = true;
                    document.getElementById('readBtn').disabled = true;
                    document.getElementById('subscribeBtn').disabled = true;
                    document.getElementById('unsubscribeBtn').disabled = true;
                }
            }

            updateScanStatus(status) {
                const scanStatusDiv = document.getElementById('scanStatus');
                const scanBtn = document.getElementById('scanBtn');

                if (status === 'scanning') {
                    scanStatusDiv.className = 'status scanning';
                    scanStatusDiv.textContent = 'üîç „Çπ„Ç≠„É£„É≥‰∏≠...';
                    scanStatusDiv.style.display = 'block';
                    scanBtn.disabled = true;
                } else {
                    scanStatusDiv.style.display = 'none';
                    scanBtn.disabled = false;
                }
            }

            log(message, type = 'info') {
                const logArea = document.getElementById('logArea');
                const timestamp = new Date().toLocaleTimeString();
                const logEntry = document.createElement('div');

                let color = '#e2e8f0';
                if (type === 'error') color = '#feb2b2';
                if (type === 'success') color = '#9ae6b4';
                if (type === 'warning') color = '#fbb6ce';

                logEntry.style.color = color;
                logEntry.innerHTML = `[${timestamp}] ${message}`;
                logArea.appendChild(logEntry);
                logArea.scrollTop = logArea.scrollHeight;
            }

            clearLog() {
                document.getElementById('logArea').innerHTML = '';
            }

            showError(message) {
                // „Ç®„É©„Éº„ÉÄ„Ç§„Ç¢„É≠„Ç∞„ÇíË°®Á§∫
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error';
                errorDiv.textContent = message;

                document.querySelector('.container').insertBefore(errorDiv, document.querySelector('.container').firstChild);

                // 5ÁßíÂæå„Å´Ëá™Âãï„ÅßÂâäÈô§
                setTimeout(() => {
                    errorDiv.remove();
                }, 5000);
            }

            getServiceName(uuid) {
                const serviceNames = {
                    '00001800-0000-1000-8000-00805f9b34fb': 'Generic Access',
                    '00001801-0000-1000-8000-00805f9b34fb': 'Generic Attribute',
                    '0000180a-0000-1000-8000-00805f9b34fb': 'Device Information',
                    '0000180f-0000-1000-8000-00805f9b34fb': 'Battery Service',
                    '00001812-0000-1000-8000-00805f9b34fb': 'Human Interface Device',
                    '0000181a-0000-1000-8000-00805f9b34fb': 'Environmental Sensing',
                    '0000181b-0000-1000-8000-00805f9b34fb': 'Body Composition'
                };
                return serviceNames[uuid] || 'Unknown Service';
            }

            getCharacteristicName(uuid) {
                const characteristicNames = {
                    '00002a00-0000-1000-8000-00805f9b34fb': 'Device Name',
                    '00002a01-0000-1000-8000-00805f9b34fb': 'Appearance',
                    '00002a04-0000-1000-8000-00805f9b34fb': 'Peripheral Preferred Connection Parameters',
                    '00002a05-0000-1000-8000-00805f9b34fb': 'Service Changed',
                    '00002a19-0000-1000-8000-00805f9b34fb': 'Battery Level',
                    '00002a29-0000-1000-8000-00805f9b34fb': 'Manufacturer Name String',
                    '00002a24-0000-1000-8000-00805f9b34fb': 'Model Number String',
                    '00002a25-0000-1000-8000-00805f9b34fb': 'Serial Number String',
                    '00002a27-0000-1000-8000-00805f9b34fb': 'Hardware Revision String',
                    '00002a26-0000-1000-8000-00805f9b34fb': 'Firmware Revision String',
                    '00002a28-0000-1000-8000-00805f9b34fb': 'Software Revision String'
                };
                return characteristicNames[uuid] || 'Unknown Characteristic';
            }
        }

        // „Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥„ÇíÂàùÊúüÂåñ
        const central = new WebBLECentral();

        // „Éö„Éº„Ç∏„É≠„Éº„ÉâÊôÇ„ÅÆÂàùÊúüÂåñ
        document.addEventListener('DOMContentLoaded', () => {
            central.log('üöÄ WebBLE Central „ÅåËµ∑Âãï„Åó„Åæ„Åó„Åü', 'success');
            central.log('üì± BLE „Éá„Éê„Ç§„Çπ„ÅÆ„ÉÜ„Çπ„Éà„ÇíÈñãÂßã„Åß„Åç„Åæ„Åô', 'info');
        });
    </script>
</body>
</html>
